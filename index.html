<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SBAR Anestesia</title>
  <style>
    :root{
      --accent:#2c7be5; --muted:#566; --bg:#f3f7fb; --card:#fff; --radius:10px;
    }
    body{font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif; background:var(--bg); margin:0; padding:18px; color:#123;}
    .container{max-width:980px;margin:0 auto;}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
    header h1{margin:0;font-size:20px;color:var(--accent)}
    .muted{color:var(--muted);font-size:13px}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 2px 8px rgba(20,30,60,0.06);margin-bottom:12px}
    details{margin-bottom:8px;border-radius:8px;overflow:hidden}
    summary{cursor:pointer;padding:10px 12px;background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent);font-weight:600;border-bottom:1px solid rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:space-between}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"],input[type="number"],select,textarea{width:100%;padding:8px;border:1px solid #d6dde8;border-radius:6px;font-size:14px;background:#fff;box-sizing:border-box}
    textarea{min-height:70px;resize:vertical}
    .inline{display:flex;gap:8px;align-items:center}
    .inline > *{flex:1}
    .small{max-width:220px}
    .checkbox-group{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .checkbox-group label{font-weight:500;font-size:13px;cursor:pointer;color:#243447}
    .actions{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap}
    button{background:var(--accent);color:#fff;border:0;padding:9px 12px;border-radius:8px;cursor:pointer}
    button.secondary{background:#6c757d}
    #resultado{white-space:pre-wrap;padding:12px;background:#fcfdff;border-radius:8px;border:1px solid #e6eefc;min-height:120px}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    @media(max-width:720px){.grid{grid-template-columns:1fr}.grid-3{grid-template-columns:1fr} header{flex-direction:column;align-items:flex-start;gap:6px}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>SBAR Anestesia</h1>
      <div class="muted">Gerador de texto intraoperat√≥rio ‚Äî vers√£o avan√ßada</div>
    </header>

    <!-- SITUA√á√ÉO -->
    <details open class="card">
      <summary>üü¢ Situa√ß√£o</summary>
      <div style="padding:12px 6px;">
        <div class="grid">
          <div>
            <label>Nome / Sexo / Idade</label>
            <div class="inline">
              <input type="text" id="nome" placeholder="Ex: Jo√£o Silva"/>
              <select id="sexo"><option value="">Sexo</option><option value="masculino">Masculino</option><option value="feminino">Feminino</option></select>
              <input type="number" id="idade" placeholder="Idade" min="0"/>
            </div>
            <div class="hint">  </div>
          </div>

          <div>
            <label>Motivo da interna√ß√£o / Procedimento planejado</label>
            <div class="inline">
              <input type="text" id="motivo" placeholder="Ex: Apendicite aguda"/>
              <input type="text" id="procedimento" placeholder="Ex: Apendicectomia videolaparosc√≥pica"/>
            </div>
            <div class="hint">  </div>
          </div>
        </div>

        <div class="grid" style="margin-top:10px">
          <div>
            <label>Origem do paciente</label>
            <select id="origem">
              <option value="">Selecione</option>
              <option value="emergencia">Setor de Emerg√™ncia</option>
              <option value="enfermaria">Enfermaria</option>
              <option value="uti">UTI</option>
            </select>
          </div>

          <div>
            <label>Chegada j√° intubado / monitorizado / VM</label>
            <div class="checkbox-group">
              <label><input type="checkbox" id="chegaIntubado" /> Intubado</label>
              <label><input type="checkbox" id="chegaMonitorizado" /> Monitorizado</label>
              <label><input type="checkbox" id="chegaVM" /> Em VM</label>
            </div>
            <div class="hint">Dispon√≠vel para Emerg√™ncia e UTI.</div>
          </div>
        </div>

        <div id="origemDetalhes" style="margin-top:10px;display:none;">
          <div class="card" style="padding:10px">
            <label>Ventila√ß√£o (na origem)</label>
            <div class="checkbox-group">
              <label><input type="checkbox" id="origVM" value="Ventila√ß√£o mec√¢nica" /> Ventila√ß√£o mec√¢nica</label>
              <label><input type="checkbox" id="origEspont" value="Espont√¢neo" /> Espont√¢neo</label>
              <label><input type="checkbox" id="origO2" value="O2 suplementar" /> O‚ÇÇ suplementar</label>
              <label><input type="checkbox" id="origTraq" value="Traqueostomia" /> Traqueostomia</label>
            </div>

            <label style="margin-top:8px">Drogas vasoativas (na origem)</label>
            <div class="checkbox-group" id="drogasOrigem">
              <label><input type="checkbox" value="Noradrenalina" /> Noradrenalina</label>
              <label><input type="checkbox" value="Vasopressina" /> Vasopressina</label>
              <label><input type="checkbox" value="Dobutamina" /> Dobutamina</label>
              <label><input type="checkbox" value="Efedrina" /> Efedrina</label>
              <label><input type="checkbox" value="Metaraminol" /> Metaraminol</label>
              <label><input type="checkbox" id="drogasOrigemOutrosChk" value="Outros" /> Outros</label>
              <input type="text" id="drogasOrigemOutros" class="small" style="display:none" placeholder="Especifique outros"/>
            </div>
          </div>
        </div>
      </div>
    </details>

    <!-- BACKGROUND -->
    <details class="card" open>
      <summary>üî∑ Background</summary>
      <div style="padding:12px 6px;">
        <div class="grid">
          <div>
            <label>ASA</label>
            <div class="inline">
              <select id="asa"><option value="">ASA</option><option>ASA I</option><option>ASA II</option><option>ASA III</option><option>ASA IV</option><option>ASA V</option></select>
              <label style="margin-left:6px"><input type="checkbox" id="asaE" /> E (emerg√™ncia)</label>
            </div>
            <div class="hint">Marque E se for caso de emerg√™ncia.</div>
          </div>

          <div>
            <label>Peso / Altura</label>
            <div class="inline">
              <input type="number" id="peso" placeholder="kg" min="0"/>
              <input type="number" id="altura" placeholder="cm" min="0"/>
            </div>
            <div class="hint">Peso e altura na mesma linha.</div>
          </div>
        </div>

        <div style="margin-top:10px" class="grid">
          <div>
            <label>Alergias</label>
            <input type="text" id="alergias" placeholder="Ex: Penicilina"/>
          </div>

          <div>
            <label>Comorbidades</label>
            <div class="checkbox-group" id="comorbidadesDiv">
              <label><input type="checkbox" value="Hipertens√£o" /> Hipertens√£o</label>
              <label><input type="checkbox" value="DM" id="dmChk" /> DM</label>
              <label><input type="checkbox" value="DAC" /> DAC</label>
              <label><input type="checkbox" value="DPOC" /> DPOC</label>
              <label><input type="checkbox" value="DRC" /> DRC</label>
              <label><input type="checkbox" id="comorbOutrosChk" value="Outros" /> Outros</label>
              <input type="text" id="comorbOutrosTxt" class="small" style="display:none" placeholder="Especifique outras"/>
              <label style="width:100%;margin-top:6px"><input type="checkbox" id="semComorb" /> Sem comorbidades</label>
            </div>
          </div>
        </div>

        <div style="margin-top:10px" class="grid">
          <div>
            <label>Cirurgias pr√©vias</label>
            <input type="text" id="cirurgias" placeholder="Ex: Revasculariza√ß√£o mioc√°rdica"/>
          </div>
          <div>
            <label>Medica√ß√µes em uso</label>
            <input type="text" id="medicacoes" placeholder="Ex: Losartana, Metformina"/>
          </div>
        </div>

        <div style="margin-top:10px" class="grid">
          <div>
            <label>Tipo de cirurgia (porte)</label>
            <select id="tipoCirurgia">
              <option value="">Selecione</option>
              <option value="pequeno">Pequeno porte</option>
              <option value="m√©dio">M√©dio porte</option>
              <option value="grande">Grande porte</option>
            </select>
          </div>
          <div>
            <label>Observa√ß√µes background</label>
            <input type="text" id="bgObs" placeholder="Observa√ß√µes r√°pidas"/>
          </div>
        </div>

      </div>
    </details>

    <!-- AVALIA√á√ÉO -->
    <details class="card" open>
      <summary>üü† Avalia√ß√£o (intraoperat√≥rio)</summary>
      <div style="padding:12px 6px;">

        <!-- Indu√ß√£o / Via a√©rea -->
        <label>Indu√ß√£o anest√©sica / Via a√©rea</label>
        <div class="card" style="padding:10px;margin-bottom:10px">
          <div class="grid">
            <div>
              <label>Paciente j√° intubado (origem)?</label>
              <div class="checkbox-group">
                <label><input type="checkbox" id="jaIntubado" /> Sim (oculta campo de indu√ß√£o)</label>
              </div>
            </div>
            <div>
              <label>Dispositivo</label>
              <select id="deviceType">
                <option value="tubo">Tubo oro/nasotraqueal</option>
                <option value="ml">M√°scara lar√≠ngea</option>
                <option value="otra">Outro</option>
              </select>
            </div>
          </div>

          <div id="inducaoCampos" style="margin-top:8px">
            <div class="grid">
              <div>
                <label>Cormack-Lehane</label>
                <select id="cormack">
                  <option value="I">I</option><option value="IIa">IIa</option><option value="IIb">IIb</option>
                  <option value="III">III</option><option value="IV">IV</option>
                </select>
              </div>
              <div>
                <label>Tubo / M√°scara - n¬∫</label>
                <input type="text" id="tuboNum" placeholder="Ex: 8 (tubo) ou 4 (mascara)"/>
              </div>
            </div>

            <div class="grid" style="margin-top:8px">
              <div>
                <label>Rima (cm)</label>
                <input type="number" id="rima" placeholder="Ex: 20" min="0"/>
              </div>
              <div>
                <label>Oro / Naso</label>
                <select id="oroNaso"><option value="oro">Orotraqueal</option><option value="naso">Nasotraqueal</option></select>
              </div>
            </div>

            <div style="margin-top:8px" class="checkbox-group">
              <label><input type="checkbox" id="aramado" /> Aramado</label>
              <label><input type="checkbox" id="video" /> Uso de videolaringosc√≥pio</label>
              <label><input type="checkbox" id="fibro" /> Fibrobroncosc√≥pio</label>
              <label><input type="checkbox" id="bougie" /> Bougie</label>
              <label><input type="checkbox" id="vaDificil" /> Via a√©rea dif√≠cil</label>
              <label><input type="checkbox" id="ventDificil" /> Ventila√ß√£o dif√≠cil</label>
            </div>

            <div style="margin-top:8px">
              <label>Intercorr√™ncias / observa√ß√µes via a√©rea</label>
              <input type="text" id="inducaoObs" placeholder="Descreva intercorr√™ncias (se houver)"/>
            </div>
          </div>
          <div class="hint">Se o paciente j√° chega intubado pela orig (UTI/Emerg√™ncia), marque "Paciente j√° intubado" para ocultar estes campos (n√£o preench√™-los).</div>
        </div>

        <!-- Tipo de anestesia -->
        <label>Tipo de anestesia</label>
        <div class="checkbox-group" id="anestesiaDiv">
          <label><input type="checkbox" id="agBalanceada" /> AG balanceada</label>
          <label><input type="checkbox" id="tiva" /> TIVA</label>
          <label><input type="checkbox" id="sedacao" /> Seda√ß√£o</label>
          <label><input type="checkbox" id="combinada" /> Combinada</label>
        </div>

        <div id="combinadaOpcoes" style="display:none;margin-top:8px">
          <label>Se combinada, quais?</label>
          <div class="checkbox-group">
            <label><input type="checkbox" id="raqui" /> Raquianestesia</label>
            <label><input type="checkbox" id="peridural" /> Peridural</label>
            <label><input type="checkbox" id="bloqueioPerif" /> Bloqueio perif√©rico</label>
            <label><input type="checkbox" id="combOutrosChk" /> Outros</label>
            <input type="text" id="combOutrosTxt" class="small" style="display:none" placeholder="Especifique outros"/>
          </div>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #eef5ff"/>

        <!-- Monitoriza√ß√£o -->
        <label>Monitoriza√ß√£o</label>
        <div>
          <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="monitorPadrao" checked /> <strong>Monitoriza√ß√£o padr√£o (ECG, SpO‚ÇÇ, PNI, capnografia)</strong></label>
          <div class="checkbox-group" id="monitorExtras" style="margin-top:6px">
            <label><input type="checkbox" id="monTemp" value="Temperatura" /> Temperatura</label>
            <label><input type="checkbox" id="monPAI" value="PAI" /> PAI</label>
            <label><input type="checkbox" id="monPVC" value="PVC" /> PVC</label>
            <label><input type="checkbox" id="monBIS" value="BIS" /> BIS</label>
            <label><input type="checkbox" id="monOutrosChk" value="Outros" /> Outros</label>
            <input type="text" id="monOutrosTxt" class="small" style="display:none" placeholder="Especifique"/>
          </div>
          <div class="hint">Se PAI marcado, o relat√≥rio n√£o repetir√° PNI (evita redund√¢ncia).</div>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #eef5ff"/>

        <!-- Hemodin√¢mica -->
        <label>Hemodin√¢mica</label>
        <div>
          <div class="checkbox-group">
            <label><input type="checkbox" id="hemoEstavel" checked /> Est√°vel</label>
            <label><input type="checkbox" id="hemoInstavel" /> Inst√°vel</label>
          </div>

          <div id="hemoInstDetalhes" style="display:none;margin-top:8px">
            <label>Se inst√°vel, marque vasopressores / arritmia / outras</label>
            <div class="checkbox-group" style="margin-top:6px">
              <label><input type="checkbox" id="usoVaso" /> Uso de vasopressores</label>
              <label><input type="checkbox" id="hemoArritmia" value="Arritmia" /> Arritmia</label>
              <label><input type="checkbox" id="hemoOutrasChk" value="Outras" /> Outras</label>
            </div>

            <div id="vasoDetalhes" style="display:none;margin-top:8px">
              <label>Vasopressores utilizados (se aplic√°vel)</label>
              <div class="checkbox-group">
                <label><input type="checkbox" class="vasoChk" value="Noradrenalina" /> Noradrenalina</label>
                <label><input type="checkbox" class="vasoChk" value="Vasopressina" /> Vasopressina</label>
                <label><input type="checkbox" class="vasoChk" value="Dobutamina" /> Dobutamina</label>
                <label><input type="checkbox" class="vasoChk" value="Nitroprussiato" /> Nitroprussiato</label>
                <label><input type="checkbox" class="vasoChk" value="Nitroglicerina" /> Nitroglicerina</label>
                <label><input type="checkbox" class="vasoChk" value="Efedrina" /> Efedrina</label>
                <label><input type="checkbox" class="vasoChk" value="Metaraminol" /> Metaraminol</label>
                <label><input type="checkbox" id="vasoOutrosChk" value="Outros" /> Outros</label>
                <input type="text" id="vasoOutrosTxt" class="small" style="display:none" placeholder="Especifique outros"/>
              </div>
            </div>

            <div style="margin-top:8px">
              <label>Observa√ß√µes hemodin√¢micas</label>
              <input type="text" id="hemoObs" placeholder="Ex: epis√≥dios de hipotens√£o, resposta a bolus..."/>
            </div>
          </div>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #eef5ff"/>

        <!-- Respirat√≥rio -->
        <label>Respirat√≥rio</label>
        <div>
          <div class="checkbox-group" id="respDiv">
            <label><input type="checkbox" id="respVM" /> Em VM</label>
            <label><input type="checkbox" id="respEspont" /> Espont√¢neo</label>
            <label><input type="checkbox" id="respO2" /> O‚ÇÇ suplementar</label>
            <label><input type="checkbox" id="respTraq" /> Traqueostomizado</label>
            <label><input type="checkbox" id="respOutrosChk" value="Outros" /> Outros</label>
          </div>

          <div id="vmParams" style="display:none;margin-top:8px">
            <label>Par√¢metros ventilat√≥rios</label>
            <div class="grid-3" style="gap:8px">
              <div>
                <label>Modo</label>
                <select id="vmModo"><option value="VCV">VCV</option><option value="PCV">PCV</option><option value="PS">PS</option></select>
              </div>
              <div>
                <label>Vc (mL)</label>
                <input type="number" id="vmVc" min="0" placeholder="500"/>
              </div>
              <div>
                <label>FR (ipm)</label>
                <input type="number" id="vmFr" min="0" placeholder="12"/>
              </div>
            </div>

            <div class="grid" style="margin-top:8px">
              <div>
                <label>FiO‚ÇÇ</label>
                <input type="text" id="vmFiO2" placeholder="0,5"/>
              </div>
              <div>
                <label>PEEP (cmH‚ÇÇO)</label>
                <input type="number" id="vmPeep" min="0" placeholder="5"/>
              </div>
              <div>
                <label>Ppico (cmH‚ÇÇO)</label>
                <input type="number" id="vmPico" min="0" placeholder="--"/>
              </div>
            </div>

            <div style="margin-top:8px" class="inline">
              <div style="flex:1">
                <label>dP (Driving-pressure)</label>
                <input type="text" id="vmDelta" placeholder="Ex: &lt;15"/>
              </div>
              <div style="flex:1">
                <label>Observa√ß√µes ventilat√≥rias</label>
                <input type="text" id="respInterc" placeholder="Intercorr√™ncias / observa√ß√µes (se houver)"/>
              </div>
            </div>
            <div class="hint">Padr√µes iniciais: VCV, Vc 500 mL, FR 12, FiO‚ÇÇ 0,5, PEEP 5 cmH‚ÇÇO.</div>
          </div>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #eef5ff"/>

        <!-- Renal -->
        <div class="grid">
          <div>
            <label>Renal - Aporte (mL)</label>
            <input type="number" id="aporteLiquidos" placeholder="Ex: 2000" min="0"/>
          </div>
          <div>
            <label>Renal - Diurese (mL)</label>
            <input type="number" id="diurese" placeholder="Ex: 500" min="0"/>
          </div>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #eef5ff"/>

        <!-- Infeccioso -->
        <label>Infeccioso</label>
        <div class="grid" style="align-items:center">
          <div>
            <label>Antibi√≥tico</label>
            <input type="text" id="antibiotico" placeholder="Ex: Ceftriaxona"/>
          </div>
          <div>
            <label>Hor√°rio de repique</label>
            <input type="text" id="horarioRepique" placeholder="Ex: 06:00 / 18:00"/>
          </div>
        </div>
        <input type="text" id="infOutros" placeholder="Outras informa√ß√µes infecciosas (opcional)" style="margin-top:8px"/>

        <hr style="margin:12px 0;border:none;border-top:1px solid #eef5ff"/>

        <!-- Hematol√≥gico -->
        <label>Hematol√≥gico</label>
        <div>
          <label><input type="checkbox" id="transfusaoChk" /> Transfus√£o realizada</label>

          <div id="transfusaoDetalhes" style="display:none;margin-top:8px">
            <label>Quantidade por hemocomponente</label>
            <div class="grid">
              <div><label>CH (unidades)</label><input type="number" id="qtyCH" min="0" placeholder="Ex: 2"/></div>
              <div><label>PFC (unidades)</label><input type="number" id="qtyPFC" min="0" placeholder="Ex: 1"/></div>
            </div>
            <div class="grid" style="margin-top:8px">
              <div><label>Plaquetas (unidades)</label><input type="number" id="qtyPlaq" min="0" placeholder="Ex: 1"/></div>
              <div><label>Crioprecipitado (unidades)</label><input type="number" id="qtyCriop" min="0" placeholder="Ex: 0"/></div>
            </div>
            <div style="margin-top:8px">
              <label>Outros hemocomponentes</label>
              <input type="text" id="hemoOutrosTxt" placeholder="Ex: 1 unidade de concentrado plaquet√°rio..."/>
            </div>
            <div style="margin-top:8px" class="inline">
              <div style="flex:1"><label>Sangramento estimado (mL)</label><input type="number" id="sangramentoEstimado" min="0" placeholder="Ex: 600"/></div>
              <div style="flex:1"><label>Observa√ß√µes hematol√≥gicas</label><input type="text" id="hemoObs" placeholder="Observa√ß√µes"/></div>
            </div>
          </div>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #eef5ff"/>

        <!-- End√≥crino -->
        <label>End√≥crino</label>
        <div class="inline">
          <input type="text" id="glicemia" placeholder="Glicemia (mg/dL)"/>
          <input type="text" id="endocrinoObs" placeholder="Outras considera√ß√µes end√≥crinas"/>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #eef5ff"/>

        <!-- Laboratoriais -->
        <label>Dados laboratoriais (campo livre)</label>
        <input type="text" id="labs" placeholder="Ex: Hb 12,3 g/dL; gasometria: pH 7,38; Na 140; K 3,9"/>

      </div>
    </details>

    <!-- RECOMENDA√á√ÉO -->
    <details class="card" open>
      <summary>üî¥ Recomenda√ß√£o</summary>
      <div style="padding:12px 6px;">
        <div class="grid">
          <div>
            <label>Transporte / Monitoriza√ß√£o</label>
            <div class="checkbox-group">
              <label><input type="checkbox" id="monitorizacaoContinua" /> Monitoriza√ß√£o cont√≠nua</label>
              <label><input type="checkbox" id="usoVasoTransp" /> Uso de drogas vasoativas</label>
            </div>
          </div>

          <div>
            <label>Seda√ß√£o</label>
            <div class="checkbox-group" id="sedacaoDiv">
              <label><input type="checkbox" value="Sedado" /> Sedado</label>
              <label><input type="checkbox" value="Despertando" /> Despertando</label>
              <label><input type="checkbox" value="Acordado" /> Acordado</label>
            </div>
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Ventila√ß√£o/Observa√ß√µes</label>
          <div class="checkbox-group" id="ventilacaoDiv">
            <label><input type="checkbox" value="Em ventila√ß√£o mec√¢nica" /> Em VM</label>
            <label><input type="checkbox" value="Espontaneamente" /> Espontaneamente</label>
            <label><input type="checkbox" value="O2 suplementar" /> O2 suplementar</label>
            <label><input type="checkbox" value="Traqueostomizado" /> Traqueostomizado</label>
          </div>
          <textarea id="observacoes" placeholder="Observa√ß√µes / recomenda√ß√µes (opcional)"></textarea>
        </div>

        <div class="actions">
          <button id="btnGerar">Gerar Relat√≥rio</button>
          <button class="secondary" id="btnResumoCurto">Gerar Resumo Curto</button>
          <button class="secondary" id="btnCopiar">Copiar Relat√≥rio</button>
          <button id="btnPDF">Gerar PDF</button>
          <button class="secondary" id="btnNovo">Novo caso</button>
        </div>
      </div>
    </details>

    <h2 style="margin-top:6px">üìù Relat√≥rio Gerado</h2>
    <div id="resultado" class="card"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // Helper shortcuts
    const $ = id => document.getElementById(id);
    const show = id => { if($(id)) $(id).style.display = 'block'; };
    const hide = id => { if($(id)) $(id).style.display = 'none'; };
    const isChecked = id => (!!$(id) && $(id).checked);
    const checkedValues = nodeList => Array.from(nodeList).filter(n=>n.checked && n.value).map(n=>n.value);
    const join = arr => arr.filter(Boolean).join(', ');

    // UI wiring
    function initUI(){
      // origem details (show when origem is uti or emergencia)
      $('origem').addEventListener('change', ()=>{
        const v = $('origem').value;
        if(v==='uti' || v==='emergencia') show('origemDetalhes'); else hide('origemDetalhes');
      });

      // drugs origin others
      $('drogasOrigemOutrosChk').addEventListener('change', (e)=> { if(e.target.checked) show('drogasOrigemOutros'); else hide('drogasOrigemOutros'); });

      // sem comorb
      $('semComorb').addEventListener('change', (e)=> {
        if(e.target.checked){
          document.querySelectorAll('#comorbidadesDiv input[type="checkbox"]').forEach(cb=>{ if(cb.id!=='semComorb') cb.checked=false; });
        }
      });
      $('comorbOutrosChk').addEventListener('change', (e)=> { if(e.target.checked) show('comorbOutrosTxt'); else hide('comorbOutrosTxt'); });

      // combinada
      $('combinada').addEventListener('change', e=> { if(e.target.checked) show('combinadaOpcoes'); else hide('combinadaOpcoes'); });
      $('combOutrosChk').addEventListener('change', e=> { if(e.target.checked) show('combOutrosTxt'); else hide('combOutrosTxt'); });

      // monitor extras
      $('monOutrosChk').addEventListener('change', e=> { if(e.target.checked) show('monOutrosTxt'); else hide('monOutrosTxt'); });

      // hemodinamica toggles
      $('hemoInstavel').addEventListener('change', e=>{
        if(e.target.checked){ show('hemoInstDetalhes'); $('hemoEstavel').checked = false; }
        else { hide('hemoInstDetalhes'); }
      });
      $('hemoEstavel').addEventListener('change', e=>{ if(e.target.checked){ $('hemoInstavel').checked=false; hide('hemoInstDetalhes'); } });

      $('usoVaso').addEventListener('change', e=>{ if(e.target.checked) show('vasoDetalhes'); else hide('vasoDetalhes'); });
      $('vasoOutrosChk').addEventListener('change', e=>{ if(e.target.checked) show('vasoOutrosTxt'); else hide('vasoOutrosTxt'); });

      // transfus√£o
      $('transfusaoChk').addEventListener('change', e=>{ if(e.target.checked) show('transfusaoDetalhes'); else hide('transfusaoDetalhes'); });

      // ventila√ß√£o params show/hide
      $('respVM').addEventListener('change', e=>{ if(e.target.checked) show('vmParams'); else hide('vmParams'); });

      // respOutros placeholder (no UI)
      // indu√ß√£o: hide fields if jaIntubado
      $('jaIntubado').addEventListener('change', e=>{ if(e.target.checked) hide('inducaoCampos'); else show('inducaoCampos'); });

      // device type: if m√°scara, placeholder for n¬∫
      $('deviceType').addEventListener('change', e=>{
        const v = e.target.value;
        if(v==='ml'){ $('tuboNum').placeholder = 'Ex: 4 (m√°scara)'; }
        else { $('tuboNum').placeholder = 'Ex: 8 (tubo)'; }
      });

      // combinadaOutros toggles
      $('combOutrosChk').addEventListener('change', e=>{ if(e.target.checked) show('combOutrosTxt'); else hide('combOutrosTxt'); });

      // default prechecks
      window.addEventListener('load', ()=>{
        $('monitorPadrao').checked = true;
        $('hemoEstavel').checked = true;
        setDefaultsBySex();
      });

      // Adjust induction defaults when sex changes
      $('sexo').addEventListener('change', setDefaultsBySex);
    }

    function setDefaultsBySex(){
      const sexo = $('sexo').value;
      if(sexo==='masculino'){
        if(!$('tuboNum').value) $('tuboNum').value = '8';
      } else if(sexo==='feminino'){
        if(!$('tuboNum').value) $('tuboNum').value = '7.5';
      } else {
        // no sex chosen: leave default 7.5
        if(!$('tuboNum').value) $('tuboNum').value = '7.5';
      }
      if(!$('cormack').value) $('cormack').value = 'I';
      if(!$('rima').value) $('rima').value = 20;
      // VM defaults
      if(!$('vmVc').value) $('vmVc').value = 500;
      if(!$('vmFr').value) $('vmFr').value = 12;
      if(!$('vmFiO2').value) $('vmFiO2').value = '0,5';
      if(!$('vmPeep').value) $('vmPeep').value = 5;
      if(!$('vmDelta').value) $('vmDelta').value = '<15';
    }

    // Text generation helpers
    function genderArticle(){
      const s = $('sexo').value;
      if(s==='feminino') return 'A paciente';
      return 'O paciente';
    }
    function genderLower(){
      const s = $('sexo').value;
      if(s==='feminino') return 'a paciente';
      return 'o paciente';
    }

    function gerarSituacao(){
      const nome = $('nome').value.trim() || 'Paciente';
      const sexo = $('sexo').value;
      const idade = $('idade').value ? (', ' + $('idade').value + ' anos') : '';
      const ident = `${nome}${idade}${sexo?`, sexo ${sexo}`:''}`;
      const motivo = $('motivo').value.trim();
      const proc = $('procedimento').value.trim();
      const origem = $('origem').value;
      let origemFrase = '';
      if(origem==='emergencia') origemFrase = 'proveniente do Setor de Emerg√™ncia';
      if(origem==='enfermaria') origemFrase = 'proveniente da enfermaria';
      if(origem==='uti') origemFrase = 'proveniente da UTI';

      // origem extras (intubado/monitorizado/vm/drogas)
      if((origem==='uti' || origem==='emergencia')){
        const parts = [];
        if($('chegaIntubado').checked) parts.push('intubado');
        if($('chegaMonitorizado').checked) parts.push('monitorizado');
        if($('chegaVM').checked) parts.push('em ventila√ß√£o mec√¢nica');
        // drogas
        const drogas = checkedValues(document.querySelectorAll('#drogasOrigem input[type="checkbox"]'));
        if(drogas.length){
          const idx = drogas.indexOf('Outros');
          if(idx!==-1 && $('drogasOrigemOutros').value.trim()) drogas[idx] = 'Outros: '+$('drogasOrigemOutros').value.trim();
          parts.push('em uso de '+drogas.join(', '));
        }
        if(parts.length) origemFrase += ', ' + parts.join(', ');
      }

      let primeira = `${ident}`;
      let segunda = '';
      if(motivo || proc || origemFrase){
        let p = [];
        if(motivo) p.push(`hist√≥ria de ${motivo.toLowerCase()}`);
        if(proc) p.push(`plano de ${proc.toLowerCase()}`);
        if(origemFrase) p.push(origemFrase);
        segunda = `${genderArticle()} foi levad${$('sexo').value==='feminino' ? 'a' : 'o'} ao centro cir√∫rgico com ${p.join(', ')}.`;
      }
      return [primeira, segunda].filter(Boolean).join('\n');
    }

    function gerarBackground(){
      const asa = $('asa').value ? $('asa').value + ($('asaE').checked ? '-E' : '') : '';
      const peso = $('peso').value ? $('peso').value + ' kg' : '';
      const altura = $('altura').value ? $('altura').value + ' cm' : '';
      const alergias = $('alergias').value.trim() || 'Nega alergias';
      // comorb
      let comorbidades = 'Nega comorbidades';
      if(!$('semComorb').checked){
        const arr = [];
        document.querySelectorAll('#comorbidadesDiv input[type="checkbox"]').forEach(cb=>{
          if(cb.checked && cb.value && cb.id!=='comorbOutrosChk' && cb.id!=='semComorb') arr.push(cb.value);
        });
        if($('comorbOutrosChk').checked && $('comorbOutrosTxt').value.trim()) arr.push('Outros: '+$('comorbOutrosTxt').value.trim());
        if(arr.length) comorbidades = arr.join(', ');
      }
      const cirurgias = $('cirurgias').value.trim() || 'Nega cirurgias pr√©vias';
      const medicacoes = $('medicacoes').value.trim() || 'Nega medica√ß√µes em uso';
      const tipoCirc = $('tipoCirurgia').value ? ('Cirurgia de ' + $('tipoCirurgia').value + ' porte') : '';
      const bgObs = $('bgObs').value.trim();

      const lines = [];
      lines.push('# B');
      if(asa) lines.push(`${asa}.`);
      if(peso || altura) lines.push(`Peso/Altura: ${peso||'n/i'} / ${altura||'n/i'}.`);
      lines.push(`Comorbidades: ${comorbidades}.`);
      lines.push(`Cirurgias pr√©vias: ${cirurgias}.`);
      lines.push(`Medica√ß√µes em uso: ${medicacoes}.`);
      lines.push(`Alergias: ${alergias}.`);
      if(tipoCirc) lines.push(tipoCirc + '.');
      if(bgObs) lines.push(bgObs + '.');
      return lines.join('\n');
    }

    function gerarAvaliacao(){
      // Indu√ß√£o / via a√©rea (omitida se jaIntubado OR foi intubado na origem)
      let inducText = '';
      const comesFromIntub = ( ($('origem').value==='uti' || $('origem').value==='emergencia') && $('chegaIntubado').checked );
      if(!$('jaIntubado').checked && !comesFromIntub){
        const device = $('deviceType').value;
        const corm = $('cormack').value;
        const tubo = $('tuboNum').value.trim();
        const rima = $('rima').value;
        const oroNaso = $('oroNaso').value === 'oro' ? 'orotraqueal' : 'nasotraqueal';
        const aram = $('aramado').checked ? 'aramado' : 'n√£o aramado';
        const video = $('video').checked ? 'videolaringosc√≥pio' : null;
        const fibro = $('fibro').checked ? 'fibrobroncosc√≥pio' : null;
        const bougie = $('bougie').checked ? 'bougie' : null;
        const vaDif = $('vaDificil').checked ? 'via a√©rea dif√≠cil' : null;
        const ventDif = $('ventDificil').checked ? 'ventila√ß√£o dif√≠cil' : null;
        const indObs = $('inducaoObs').value.trim();
        if(device==='ml'){
          inducText = `Indu√ß√£o com m√°scara lar√≠ngea n¬∫ ${tubo}${indObs?', '+indObs:''}.`;
        } else {
          inducText = `Indu√ß√£o com intuba√ß√£o ${oroNaso}, tubo ${tubo ? tubo + ' mm' : 'n¬∫ n√£o informado'}, Cormack ${corm}, rima ${rima ? rima + ' cm' : 'n/i'}, ${aram}${video?(', uso de '+video):''}${fibro?(', uso de '+fibro):''}${bougie?(', bougie') : ''}${vaDif?(', via a√©rea dif√≠cil'):''}${ventDif?(', ventila√ß√£o dif√≠cil'):''}${indObs?'. '+indObs:''}.`;
        }
      } else {
        // Patient already intubated - mention origin if applicable
        if(comesFromIntub) inducText = `Paciente proveniente da ${$('origem').value==='uti'?'UTI':'Emerg√™ncia'} j√° intubado e monitorizado.`;
        else if($('jaIntubado').checked) inducText = 'Paciente j√° intubado previamente (dados de indu√ß√£o n√£o aplic√°veis).';
      }

      // Tipo de anestesia
      const tipos = [];
      if($('agBalanceada').checked) tipos.push('anestesia geral balanceada');
      if($('tiva').checked) tipos.push('TIVA');
      if($('sedacao').checked) tipos.push('seda√ß√£o');
      if($('combinada').checked){
        const c = [];
        if($('raqui').checked) c.push('raquianestesia');
        if($('peridural').checked) c.push('peridural');
        if($('bloqueioPerif').checked) c.push('bloqueio perif√©rico');
        if($('combOutrosChk').checked && $('combOutrosTxt').value.trim()) c.push('outros: '+$('combOutrosTxt').value.trim());
        tipos.push('combinada' + (c.length?(' ('+c.join(', ')+')'):''));
      }

      // Monitoriza√ß√£o
      let monitor = [];
      if($('monitorPadrao').checked) monitor = ['ECG','SpO‚ÇÇ','PNI','capnografia'];
      if($('monTemp').checked) monitor.push('temperatura');
      if($('monBIS').checked) monitor.push('BIS');
      if($('monPVC').checked) monitor.push('PVC');
      if($('monPAI').checked){
        // remove PNI to avoid redundancy
        monitor = monitor.filter(m=>m!=='PNI');
        monitor.push('PAI');
      }
      if($('monOutrosChk').checked && $('monOutrosTxt').value.trim()) monitor.push('outros ('+$('monOutrosTxt').value.trim()+')');

      const monitorTxt = monitor.length ? 'Monitoriza√ß√£o: ' + monitor.join(', ') + '.' : '';

      // Hemodin√¢mica
      let hemoTxt = '';
      if($('hemoEstavel').checked){
        hemoTxt = 'Hemodin√¢mica: manteve-se est√°vel hemodinamicamente durante o transoperat√≥rio, em ritmo sinusal, sem necessidade de drogas vasoativas.';
      } else if($('hemoInstavel').checked){
        // require at least one vasopressor if usoVaso checked (or if inst√°vel we require vaso)
        const vasoUsed = $('usoVaso').checked;
        const vasoList = [];
        if(vasoUsed){
          document.querySelectorAll('.vasoChk').forEach(cb=>{ if(cb.checked) vasoList.push(cb.value); });
          if($('vasoOutrosChk').checked && $('vasoOutrosTxt').value.trim()) vasoList.push('Outros: '+$('vasoOutrosTxt').value.trim());
        }
        // If instable and usoVaso not checked and no vasoList, force validation later
        const arr = $('hemoArritmia').checked ? 'arritmia' : '';
        const outras = $('hemoOutrasChk').checked ? $('hemoObs').value.trim() : '';
        const partes = [];
        if(vasoUsed){
          // special phrasing for efedrina/metaraminol bolus
          const vasoBolus = vasoList.filter(v=> v === 'Efedrina' || v === 'Metaraminol');
          const vasoCont = vasoList.filter(v=> v !== 'Efedrina' && v !== 'Metaraminol');
          if(vasoBolus.length){
            partes.push('epis√≥dios hipotensivos responsivos a bolus intermitente de ' + vasoBolus.join(' e '));
          }
          if(vasoCont.length){
            partes.push('uso cont√≠nuo de ' + vasoCont.join(', '));
          }
        }
        if(arr) partes.push('arritmia');
        if(outras) partes.push(outras);
        hemoTxt = partes.length ? ('Hemodin√¢mica inst√°vel: ' + partes.join('; ') + '.') : 'Hemodin√¢mica inst√°vel (detalhes n√£o especificados).';
      }

      // Respirat√≥rio - VM details
      let respTxt = '';
      const respParts = [];
      if($('respVM').checked){
        // pull vm params
        const modo = $('vmModo').value || 'VCV';
        const vc = $('vmVc').value ? $('vmVc').value + ' mL' : 'Vc n/i';
        const fr = $('vmFr').value ? $('vmFr').value : 'FR n/i';
        const fio2 = $('vmFiO2').value || '0,5';
        const peep = $('vmPeep').value ? $('vmPeep').value + ' cmH‚ÇÇO' : 'PEEP n/i';
        const ppico = $('vmPico').value ? $('vmPico').value + ' cmH‚ÇÇO' : null;
        const dp = $('vmDelta').value || '<15';
        respTxt = `Respirat√≥rio: mantido em ventila√ß√£o mec√¢nica modo ${modo} (${vc}, FR ${fr}, FiO‚ÇÇ ${fio2}, PEEP ${peep}${ppico?(', Ppico '+ppico):''}), dP ${dp}, com par√¢metros otimizados.`;
        if($('respInterc').value.trim()) respTxt += ' ' + $('respInterc').value.trim() + '.';
      } else {
        if($('respEspont').checked || $('respO2').checked){
          const arr = [];
          if($('respEspont').checked) arr.push('ventila√ß√£o espont√¢nea');
          if($('respO2').checked) arr.push('suplementa√ß√£o de O‚ÇÇ');
          respTxt = 'Respirat√≥rio: ' + arr.join(' e ') + '.';
          if($('respInterc').value.trim()) respTxt += ' ' + $('respInterc').value.trim() + '.';
        } else if($('respTraq').checked) {
          respTxt = 'Respirat√≥rio: traqueostomizado.';
        } else if($('respOutrosChk').checked && $('respInterc').value.trim()){
          respTxt = 'Respirat√≥rio: ' + $('respInterc').value.trim() + '.';
        }
      }

      // Renal
      const aporte = $('aporteLiquidos').value ? $('aporteLiquidos').value + ' mL' : '';
      const diurese = $('diurese').value ? $('diurese').value + ' mL' : '';
      const renalTxt = (aporte || diurese) ? ('Renal: ' + [aporte ? ('Aporte ' + aporte) : '', diurese ? ('Diurese ' + diurese) : ''].filter(Boolean).join(', ') + '.') : '';

      // Infeccioso
      const atb = $('antibiotico').value.trim();
      const rep = $('horarioRepique').value.trim();
      let infTxt = '';
      if(atb) infTxt = 'Antibi√≥tico: ' + atb + (rep ? ' (repique: '+rep+')' : '') + ( $('infOutros').value.trim() ? '. ' + $('infOutros').value.trim() : '.' );
      else if($('infOutros').value.trim()) infTxt = 'Infeccioso: ' + $('infOutros').value.trim() + '.';

      // Hematol√≥gico
      let hemTxt = '';
      if($('transfusaoChk').checked){
        const ch = $('qtyCH').value ? $('qtyCH').value+' CH' : '';
        const pfc = $('qtyPFC').value ? $('qtyPFC').value+' PFC' : '';
        const plaq = $('qtyPlaq').value ? $('qtyPlaq').value+' Plaquetas' : '';
        const criop = $('qtyCriop').value ? $('qtyCriop').value+' Crioprecipitado' : '';
        const outros = $('hemoOutrosTxt').value.trim();
        const sang = $('sangramentoEstimado').value ? $('sangramentoEstimado').value + ' mL' : '';
        const comps = [ch,pfc,plaq,criop].filter(Boolean);
        if(outros) comps.push(outros);
        hemTxt = 'Hematol√≥gico: transfundido com ' + (comps.length ? comps.join(', ') : 'hemocomponentes n√£o especificados') + (sang ? (', sangramento estimado em ' + sang) : '') + '.';
        if($('hemoObs').value.trim()) hemTxt += ' ' + $('hemoObs').value.trim() + '.';
      } else {
        hemTxt = 'Hematol√≥gico: sem hemocomponentes administrados.';
      }

      // Endocrino
      const glic = $('glicemia').value.trim();
      const endObs = $('endocrinoObs').value.trim();
      const endoTxt = (glic ? 'Glicemia: ' + glic + ' mg/dL.' : '') + (endObs ? ' ' + endObs + '.' : '');

      // Labs
      const labs = $('labs').value.trim();
      const labsTxt = labs ? 'Laboratoriais relevantes: ' + labs + (labs.endsWith('.') ? '' : '.') : '';

      // Monta bloco A
      const linhas = ['# A'];
      if(inducText) linhas.push(inducText);
      if(tipos.length) linhas.push('Submetido a ' + tipos.join(', ') + '.');
      if(monitorTxt) linhas.push(monitorTxt);
      if(hemoTxt) linhas.push(hemoTxt);
      if(respTxt) linhas.push(respTxt);
      if(renalTxt) linhas.push(renalTxt);
      if(infTxt) linhas.push(infTxt);
      if(hemTxt) linhas.push(hemTxt);
      if(endoTxt) linhas.push(endoTxt);
      if(labsTxt) linhas.push(labsTxt);

      return linhas.join('\n');
    }

    function gerarRecomendacao(){
      const transporte = [];
      if($('monitorizacaoContinua').checked) transporte.push('monitoriza√ß√£o cont√≠nua');
      if($('usoVasoTransp').checked) transporte.push('uso de drogas vasoativas');
      const sedR = join( Array.from(document.querySelectorAll('#sedacaoDiv input[type="checkbox"]')).filter(cb=>cb.checked).map(cb=>cb.value) );
      const ventR = join( Array.from(document.querySelectorAll('#ventilacaoDiv input[type="checkbox"]')).filter(cb=>cb.checked).map(cb=>cb.value) );
      const obs = $('observacoes').value.trim();

      const linhas = ['# R'];
      if(transporte.length) linhas.push('Transporte: ' + transporte.join(', ') + '.');
      if(sedR) linhas.push('Seda√ß√£o: ' + sedR + '.');
      if(ventR) linhas.push('Ventila√ß√£o: ' + ventR + '.');
      if(obs) linhas.push('Observa√ß√µes: ' + obs);
      return linhas.join('\n');
    }

    // Validator: if hemoInstavel -> require some vaso selected if usoVaso checked or at least some vaso if instable
    function validateBeforeGenerate(){
      if($('hemoInstavel').checked){
        // require algum vaso ou arritmia/outros descritivos
        const vasoChecked = $('usoVaso').checked && ( Array.from(document.querySelectorAll('.vasoChk')).some(cb=>cb.checked) || $('vasoOutrosChk').checked );
        const arr = $('hemoArritmia').checked;
        const outras = $('hemoOutrasChk').checked && $('hemoObs').value.trim();
        if(!vasoChecked && !arr && !outras){
          if(!confirm('Hemodin√¢mica marcada como inst√°vel mas sem vasopressores/arritmia/observa√ß√µes. Deseja continuar sem especificar vasopressores?')) return false;
        }
        // additionally, if inst√°vel and usoVaso checked, ensure at least one vaso is ticked
        if($('usoVaso').checked && !vasoChecked){
          alert('Por favor selecione ao menos um vasopressor (incluir Efedrina/Metaraminol se bolus).');
          return false;
        }
      }
      // If transfus√£o checked, require at least one qty or sangramento maybe optional; warn if none
      if($('transfusaoChk').checked){
        const anyQty = ($('qtyCH').value || $('qtyPFC').value || $('qtyPlaq').value || $('qtyCriop').value || $('hemoOutrosTxt').value.trim());
        if(!anyQty){
          if(!confirm('Transfus√£o marcada mas sem quantidades especificadas. Deseja continuar sem detalhar quantidades?')) return false;
        }
      }
      return true;
    }

    // Main generator
    let textoGerado = '';
    function gerarSBAR(full=true){
      if(!validateBeforeGenerate()) return;

      const s = gerarSituacao();
      const b = gerarBackground();
      const a = gerarAvaliacao();
      const r = gerarRecomendacao();
      const all = [s, b, a, r].filter(Boolean).join('\n\n');

      // polish text: ensure gender concordance (already basic), trim spaces
      textoGerado = all;
      $('resultado').textContent = textoGerado;
      return textoGerado;
    }

    // Summary short version
    function gerarResumoCurto(){
      if(!validateBeforeGenerate()) return;
      // pick key elements: ident, ASA, tipo anestesia, procedimento, hemodin√¢mica (stable/inst), ventila√ß√£o summary
      const nome = $('nome').value.trim() || 'Paciente';
      const asa = $('asa').value ? $('asa').value + ($('asaE').checked ? '-E' : '') : 'ASA n/i';
      const proc = $('procedimento').value.trim() || 'procedimento';
      const tipos = [];
      if($('agBalanceada').checked) tipos.push('anestesia geral balanceada');
      if($('tiva').checked) tipos.push('TIVA');
      if($('sedacao').checked) tipos.push('seda√ß√£o');
      if($('combinada').checked) tipos.push('combinada');
      const tipoStr = tipos.length ? tipos.join(', ') : 'anestesia n/i';
      const hemo = $('hemoEstavel').checked ? 'manteve-se est√°vel hemodinamicamente' : 'apresentou instabilidade hemodin√¢mica';
      // ventilation short
      let ventShort = '';
      if($('respVM').checked){
        ventShort = `VM ${$('vmModo').value || 'VCV'}, Vc ${$('vmVc').value||'n/i'} mL, FR ${$('vmFr').value||'n/i'}.`;
      } else if($('respEspont').checked){
        ventShort = 'ventila√ß√£o espont√¢nea com suplementa√ß√£o de O‚ÇÇ';
      }
      const resumo = `${nome} ‚Äî ${asa} ‚Äî submetid${$('sexo').value==='feminino'?'a':'o'} a ${tipoStr} para ${proc}. ${hemo}. ${ventShort}`;
      $('resultado').textContent = resumo;
      textoGerado = resumo;
    }

    // Copy / PDF / Novo
    function copiarTexto(){
      if(!textoGerado){ alert('Gere o relat√≥rio primeiro.'); return; }
      navigator.clipboard.writeText(textoGerado).then(()=>alert('Relat√≥rio copiado!')).catch(()=>alert('Erro ao copiar.'));
    }

    async function gerarPDF(){
      if(!textoGerado){ alert('Gere o relat√≥rio primeiro.'); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'mm', format:'a4'});
      doc.setFont('helvetica','normal'); doc.setFontSize(11);
      const lines = doc.splitTextToSize(textoGerado, 180);
      doc.text(lines, 15, 20);
      doc.save('relatorio-sbar-anestesia.pdf');
    }

    function novoCaso(){
      if(!confirm('Limpar todos os campos e iniciar novo caso?')) return;
      document.querySelectorAll('input,select,textarea').forEach(el=>{
        if(el.type==='checkbox' || el.type==='radio') el.checked = false;
        else el.value = '';
      });
      // reset some defaults
      $('monitorPadrao').checked = true;
      $('hemoEstavel').checked = true;
      setDefaultsBySex();
      hide('origemDetalhes'); hide('transfusaoDetalhes'); hide('hemoInstDetalhes'); hide('vasoDetalhes'); hide('vmParams'); hide('combinadaOpcoes'); hide('comorbOutrosTxt'); hide('drogasOrigemOutros'); hide('monOutrosTxt'); hide('inducaoCampos');
      textoGerado = ''; $('resultado').textContent = '';
    }

    // Button bindings
    document.addEventListener('DOMContentLoaded', ()=>{
      initUI();
      $('btnGerar').addEventListener('click', ()=>gerarSBAR(true));
      $('btnResumoCurto').addEventListener('click', gerarResumoCurto);
      $('btnCopiar').addEventListener('click', copiarTexto);
      $('btnPDF').addEventListener('click', gerarPDF);
      $('btnNovo').addEventListener('click', novoCaso);
    });
  </script>
</body>
</html>
